---
- name: Provision ec2 instances for Opneshift Cluster
  hosts: localhost
  connection: local
  gather_facts: False

  vars_files:
    - vars/dev-environment.yml
    - vars/aws-creds.yml

  tasks:

  - name: Launch Master Node
    ec2: 
      region: eu-west-2
      ec2_access_key: "{{ ec2_access_key }}"
      ec2_secret_key: "{{ ec2_secret_key }}"
      image: ami-7c1bfd1b
      keypair: london
      instance_type: t2.micro
      group: "default"
      wait: true
      instance_tags:
          Name: Master_Node
      count_tag:
        Name: worker_node
      exact_count: "{{num_masters}}"
    register: master
      
  - name: Launch Infra Node
    ec2: 
      region: eu-west-2
      ec2_access_key: "{{ ec2_access_key }}"
      ec2_secret_key: "{{ ec2_secret_key }}"
      image: ami-7c1bfd1b
      keypair: london
      instance_type: t2.micro
      group: "default"
      wait: true
      instance_tags:
          Name: Infra_Node
      count_tag:
        Name: worker_node
      exact_count: "{{num_infras}}"
    register: infra
      
  - name: Launch Worker Nodes
    ec2: 
      region: eu-west-2
      ec2_access_key: "{{ ec2_access_key }}"
      ec2_secret_key: "{{ ec2_secret_key }}"
      image: ami-7c1bfd1b
      keypair: london
      instance_type: t2.micro
      group: "default"
      wait: true
      instance_tags:
          Name: Worker_Node
      count_tag:
        Name: worker_node
      exact_count: "{{num_workers}}"
    register: worker
    
  - name: Add New Instances to host group
    add_host:
      host_name: "{{ item.public_ip }}"
      groupname: launched
    with_items:
     - "{{ master.instances }}"
     - "{{ infra.instances }}"
     - "{{ worker.instances }}"
     
  - name: Wait for SSH to come up
    wait_for:
        host: "{{ item.public_dns_name }}"
        port: 22
        delay: 60
        timeout: 320
        state: started
    with_items:
     - "{{ master.instances }}"
     - "{{ infra.instances }}"
     - "{{ worker.instances }}"
    
      
